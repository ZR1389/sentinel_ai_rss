# Railway deployment configuration for Sentinel AI

# Health Check Configuration
# Railway will ping this endpoint to check service health
healthcheck_path = "/health"

# Build Configuration  
[build]
  builder = "dockerfile"
  
[deploy]
  healthcheck_path = "/health"
  healthcheck_timeout = 30
  restart_policy = "on_failure"

# Cron jobs for maintenance + ingestion/enrichment
# NOTE: Disable any overlapping cron jobs in Railway dashboard (Settings → Cron)
#       to prevent duplicate runs. These railway.toml entries are authoritative.

# Maintenance
[[cron]]
  name = "retention-cleanup"
  command = "python railway_cron.py cleanup"
  schedule = "0 */6 * * *"  # Every 6 hours
  
[[cron]]
  name = "daily-vacuum"
  command = "python railway_cron.py vacuum"
  schedule = "0 2 * * *"    # Daily at 2 AM UTC

# Ingestion (→ raw_alerts)
[[cron]]
  name = "rss-ingest"
  command = "python railway_cron.py rss"
  schedule = "0 6,18 * * *"  # Twice daily at 6 AM and 6 PM UTC: RSS feeds → raw_alerts



# Enrichment (raw_alerts → alerts)
[[cron]]
  name = "engine-enrich"
  command = "python railway_cron.py engine"
  schedule = "0 7,19 * * *"  # Twice daily at 7 AM and 7 PM UTC: Threat Engine enriches raw_alerts → alerts (scoring, domains, embeddings, SOCMINT)

# Geocoding & Proximity
[[cron]]
  name = "proximity-check"
  command = "python railway_cron.py proximity"
  schedule = "0 8,20 * * *"  # Twice daily at 8 AM and 8 PM UTC: Check all travelers for nearby threats
  
[[cron]]
  name = "geocode-backfill"
  command = "python railway_cron.py geocode"
  schedule = "30 3 * * *"  # Daily at 3:30 AM UTC: Geocode missing coordinates in raw_alerts and alerts

# Temporary aggressive backfill (DISABLED: replaced by Redis/RQ queue-based geocoding)
# [[cron]]
#   name = "geocode-aggressive"
#   command = "python scripts/geocode_backfill_severity.py --dsn $DATABASE_URL --limit 1000 --max-api-calls 400"
#   schedule = "*/30 * * * *"  # Every 30 min: High API usage; disabled in favor of queue pacing

# User Notifications
[[cron]]
  name = "daily-notify"
  command = "python railway_cron.py notify"
  schedule = "0 8 * * *"  # Daily at 8:00 AM UTC: Send PDF reports and Telegram alerts to eligible users

# Trial Management
[[cron]]
  name = "trial-reminders"
  command = "python railway_cron.py trial_reminders"
  schedule = "0 10 * * *"  # Daily at 10:00 AM UTC: Send trial reminder emails (Day 1, 3, 5, 6)

[[cron]]
  name = "check-expired-trials"
  command = "python railway_cron.py check_trials"
  schedule = "0 2 * * *"  # Daily at 2:00 AM UTC: Check and expire trials, convert or downgrade users

# Environment Variables (set these in Railway Dashboard)
# Required:
# - DATABASE_URL
# - OPENAI_API_KEY (or XAI_API_KEY or DEEPSEEK_API_KEY)
# 
# Optional Retention Settings:
# - ALERT_RETENTION_DAYS=90 (default: 90 days)
# 
# Optional:
# - REDIS_URL
# - PORT (defaults to Railway's provided port)
# - KEYWORDS_SOURCE (defaults to "merge")
# - RSS_BATCH_LIMIT (default 400)
# - ENGINE_BATCH_LIMIT (default 1000)
# - GDELT_ENRICHMENT_BATCH_SIZE (default 1000)
# - GDELT_ENRICHMENT_MAX_BATCHES (default 100)
# - RSS_GROUPS (optional comma-separated list)
# - ACLED_EMAIL / ACLED_PASSWORD (required to enable ACLED)
# - ACLED_COUNTRIES (optional CSV override)
# - ACLED_DAYS_BACK (default 1, max 7)
